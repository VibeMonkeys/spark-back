# Spark Backend - 개발 기록

## 프로젝트 개요
**Spark**는 랜덤 미션 기반 소셜 게임화 플랫폼으로, 사용자들이 일상에서 재미있는 미션을 수행하고 공유하며 소통하는 서비스입니다. Hexagonal Architecture + DDD 패턴을 적용한 엔터프라이즈급 백엔드 시스템입니다.

## 2025-08-13 (프로젝트 초기 설정 및 핵심 기능)
### 1. 프로젝트 기반 구조 구축
- Spring Boot 3.5.4 + Kotlin 1.9.25 기반 프로젝트 초기화
- PostgreSQL 17.5 데이터베이스 연동 (Docker Compose)
- 헥사고날 아키텍처 기본 구조 설정
- Gradle 빌드 시스템 설정

### 2. 사용자 관리 시스템
- **회원가입/로그인**: JWT 기반 인증 시스템 기초 구현
- **프로필 관리**: 사용자 정보, 아바타, 바이오 관리
- **사용자 엔티티**: User 도메인 모델 설계
- **비밀번호 보안**: BCrypt 해싱 적용

## 2025-08-14 (핵심 기능)
### 1. 미션 관리 시스템
- **미션 엔티티**: Mission 도메인 모델 및 상태 관리 (ASSIGNED → IN_PROGRESS → COMPLETED/FAILED/EXPIRED)
- **미션 카테고리**: 5개 카테고리 (건강, 창의, 사교, 모험, 학습) 정의
- **미션 난이도**: EASY(10분, 10포인트) / MEDIUM(20분, 20포인트) / HARD(30분, 30포인트)
- **미션 템플릿**: 초기 미션 데이터 50개 생성

### 2. 스토리 및 소셜 기능
- **스토리 시스템**: 미션 인증용 스토리 생성 및 관리
- **좋아요 시스템**: Story-User 관계 매핑, 좋아요 수 실시간 업데이트
- **댓글 시스템**: StoryComment 엔티티, 계층형 댓글 지원
- **피드 시스템**: 스토리 피드 조회, 커서 기반 페이징 기초

### 3. 리워드 및 포인트 시스템
- **리워드 카테고리**: 커피, 엔터테인먼트, 음식, 도서, 건강, 체험 (6개)
- **포인트 적립**: 미션 완료 시 포인트 획득 시스템
- **리워드 교환**: 포인트로 실제 리워드 교환 메커니즘
- **만료 관리**: 리워드 유효기간 및 사용 내역 추적

### 4. 홈페이지 및 대시보드
- **대시보드 API**: 사용자 요약 정보, 오늘의 미션, 최근 스토리
- **통계 시스템**: 미션 완료율, 포인트 현황, 레벨 진행률
- **개인화**: 사용자 선호도 기반 미션 추천

### 5. 인프라 및 개발환경
- **Docker**: PostgreSQL 컨테이너화, 개발환경 표준화  
- **CORS 설정**: 환경변수 기반 동적 CORS 정책
- **DDL 설정**: Hibernate ddl-auto=update로 스키마 자동 관리
- **데이터 초기화**: init_data.sql로 샘플 데이터 자동 생성
- **실제 커밋**: `✨ 리워드 시스템을 플레이스홀더로 변경 및 사용자 스트릭 시스템 개선` (8/14 말)
- **rails 배포**: 백엔드 배포 완료 (postgreSQL 포함)

## 2025-08-15 (인증 시스템 및 미션 시스템 고도화)

### 1. JWT 인증 시스템 완성
- **JWT 토큰 시스템**: 액세스 토큰(24시간) + 리프레시 토큰(7일) 구조
- **커스텀 JWT 구현**: SHA-256 서명 방식의 자체 JWT 라이브러리
- **Spring Security 연동**: JwtAuthenticationFilter, CustomUserDetailsService
- **데모 계정**: 개발/테스트용 미리 생성된 사용자 계정 시스템
- **보안 강화**: BCrypt 해싱, 토큰 만료 관리, 로그아웃 시 토큰 무효화

### 2. 일일 미션 시스템 구축
- **일일 제한**: 하루 최대 5개 미션 시작 가능 (기존 3개에서 확장)
- **자동 할당**: 홈페이지 진입 시 사용자별 5개 미션 자동 배정
- **리롤 기능**: 배정된 미션을 새로운 미션으로 교체 (일일 제한 유지)
- **동시 진행**: 여러 미션을 동시에 IN_PROGRESS 상태로 진행 가능
- **미션 통합 API**: 미션 인증과 스토리 생성을 하나의 엔드포인트로 통합

### 3. RPG 게임화 시스템
- **6가지 스탯**: 근력, 지능, 창의성, 사교성, 모험심, 규율
- **스탯 증가 로직**: 미션 완료 시 자동 +1, 할당 가능 포인트로 +2 추가
- **스탯 할당**: 미션 완료 시 획득하는 할당 가능 포인트로 원하는 스탯 강화
- **초기 스탯**: 모든 사용자 각 스탯 10으로 시작

### 4. 업적 시스템 구현
- **12가지 업적 타입**: 미션 완료, 연속 달성, 포인트 수집, 카테고리별 전문가
- **업적 희귀도**: COMMON, RARE, EPIC, LEGENDARY, MYTHIC (5단계)
- **자동 추적**: 미션 완료, 포인트 획득 시 자동으로 업적 진행률 업데이트
- **업적 보상**: 업적 달성 시 추가 포인트 및 타이틀 획득

### 5. 미션 시스템 고도화
- **미션 상태 개선**: ASSIGNED에서 바로 COMPLETED로 변경 가능
- **미션 팩토리**: MissionFactory를 통한 미션 생성 로직 중앙화
- **미션 데이터 확장**: 50개 다양한 미션 템플릿 추가
- **미션 완료 로직**: 포인트 획득, 스탯 증가, 업적 진행 통합 처리

### 6. 소셜 기능 개선
- **좋아요 시스템**: Story-User 매핑 테이블로 중복 방지
- **실시간 좋아요 수**: 좋아요 추가/취소 시 실시간 카운트 업데이트
- **아키텍처 개선**: Repository 패턴 적용, 트랜잭션 관리
- **코드 정리**: 디버그 로그 제거, 콘솔 출력 정리
- **주요 커밋**: `feat: 좋아요 시스템 완전 구현 및 아키텍처 개선` (8/15)

## 2025-08-16 (DDD 아키텍처 완성 및 레벨 시스템 고도화)

### 1. 헥사고날 아키텍처 + DDD 완성
- **도메인 계층 순수성**: 도메인 모델에서 Spring 의존성 완전 제거
- **순수 도메인 서비스**: 비즈니스 로직을 도메인 서비스로 이동, DomainServiceConfig로 빈 등록
- **포트 & 어댑터**: Inbound/Outbound Port 명확한 분리, 어댑터 구현
- **Application Service**: UseCase 구현체로 도메인 오케스트레이션
- **Command/Query 분리**: 명령과 조회 객체 분리, CQRS 패턴 적용

### 2. 도메인 예외 시스템
- **계층별 예외**: DomainException → BusinessRuleViolationException 계층 구조
- **구체적 예외**: UserNotFoundException, MissionNotFoundException 등 구체적 예외 클래스
- **예외 코드**: 각 예외마다 고유 에러 코드 부여
- **GlobalExceptionHandler**: 중앙집중식 예외 처리

### 3. 50레벨 시스템 구현
- **8단계 타이틀**: BEGINNER → EXPLORER → ADVENTURER → EXPERT → MASTER → GRANDMASTER → LEGEND → MYTHIC
- **점진적 포인트 증가**: 1레벨(0P) → 50레벨(25,500P), 후반으로 갈수록 포인트 간격 확대
- **레벨별 혜택**: 미션 접근 권한, 특별 기능, VIP 혜택 등
- **레벨 계산 로직**: 포인트 기반 레벨 자동 계산 및 레벨업 감지

### 4. ID 시스템 통일
- **Long ID 적용**: 모든 엔티티 ID를 Long 타입으로 통일
- **Value Object ID**: UserId, MissionId 등 타입 안전성 확보
- **데이터 마이그레이션**: 기존 String ID를 Long ID로 변경
- **미션 템플릿 갱신**: 새로운 ID 시스템에 맞춰 미션 데이터 업데이트

### 5. 데모 시스템 완성
- **데모 사용자**: 개발/테스트용 미리 생성된 계정 5개
- **데모 로그인**: `/api/v1/auth/demo-login/{userId}` 원클릭 로그인
- **데모 사용자 목록**: `/api/v1/auth/demo-users` 사용 가능한 계정 목록 조회
- **법적 이슈 방지**: 리워드를 가상 상품으로 변경

### 6. 데이터 관리 개선
- **SQL 파일 분리**: init_data.sql, demo_users.sql 등 목적별 분리
- **RewardCategory 확장**: 기존 3개 → 6개 카테고리로 확장
- **데이터 일관성**: 외래키 제약조건 및 데이터 무결성 강화

### 7. 보안 문제 해결 ⚠️
- **치명적 보안 버그**: 회원가입 시 비밀번호 평문 저장 문제 해결
- **BCrypt 적용**: 모든 비밀번호를 BCrypt로 해싱 후 저장  
- **데모 계정 보안**: 데모 사용자 비밀번호도 BCrypt 해시 적용
- **API 보안**: 에러 메시지에서 민감 정보 제거
- **긴급 패치**: `fix: 회원가입 시 비밀번호가 평문으로 저장되는 중대한 보안 문제 해결` (8/16)

## 2025-08-17 (실시간 알림 & 해시태그 검색 시스템 대규모 업데이트)

### 1. 실시간 알림 시스템 구현 🔔
- **WebSocket 기반**: 실시간 양방향 통신으로 즉시 알림 전달
- **도메인 모델**: Notification 엔티티, NotificationType enum, 알림 생명주기 관리
- **헥사고날 구조**: NotificationUseCase → NotificationApplicationService → NotificationPersistenceAdapter
- **REST API**: 알림 목록 조회, 읽음 처리, 삭제 기능 `/api/v1/notifications/**`
- **미션 연동**: 미션 완료, 새 미션 할당 시 자동 알림 생성
- **주요 커밋**: `feat: 알림 시스템 도메인 모델 및 포트 구현` ~ `feat: WebSocket 알림 시스템 및 REST API 구현`

### 2. 해시태그 검색 시스템 구현 🔍  
- **전문 검색 엔진**: PostgreSQL GIN 인덱스 활용한 고성능 전문 검색
- **도메인 설계**: HashtagStats 집계 모델, 카테고리별 통계, 인기도 계산
- **검색 기능**: 
  - 실시간 자동완성 `/api/v1/hashtags/suggestions`
  - 카테고리별 필터링 (HEALTH, CREATIVE, SOCIAL, ADVENTURE, LEARNING)
  - 인기 순위별 정렬 및 트렌딩 분석
- **성능 최적화**: 커서 기반 페이징, 인덱스 최적화 SQL 스크립트
- **헥사고날 구조**: HashtagSearchUseCase → HashtagSearchApplicationService → HashtagStatsPersistenceAdapter
- **주요 커밋**: `feat: 해시태그 도메인 모델 및 Value Objects 구현` ~ `feat: 해시태그 검색 성능 최적화 SQL 스크립트`

### 3. 스토리 시스템 해시태그 통합 📝
- **자동 해시태그 추출**: 스토리 내용에서 `#태그` 패턴 자동 인식
- **해시태그 통계**: 스토리 작성 시 해시태그별 사용 빈도 자동 업데이트  
- **타입별 분류**: MISSION_PROOF(미션 인증), GENERAL(일반) 스토리 타입 구분
- **검색 통합**: 해시태그 기반 스토리 검색 기능
- **주요 커밋**: `refactor: Story 도메인 모델 해시태그 검색 지원 개선`

### 4. 미션 시스템 자동화 ⏰
- **자동 만료 스케줄러**: `@Scheduled` 기반 미션 만료 처리 (매시간 실행)
- **미션 성공률**: 카테고리별, 난이도별 미션 성공률 통계 계산
- **데이터베이스 스키마**: `attempted_by`, `success_rate` 필드 추가
- **비즈니스 로직**: 24시간 경과 미션 자동 EXPIRED 처리
- **주요 커밋**: `feat: 미션 자동 만료 스케줄러 시스템 구현`, `feat: 미션 성공률 계산 로직 구현`

### 5. 보안 강화 및 버그 수정 🔒
- **Spring Security 6 마이그레이션**: `.antMatchers()` → `.requestMatchers()` 업데이트
- **API 보안 정책**: 해시태그 검색 엔드포인트 공개, 알림은 인증 필요
- **데이터 무결성**: JSON 배열 파싱 오류 수정, GIN 인덱스 문법 오류 해결
- **미션 리롤 버그**: 일일 제한 초과하지 않도록 로직 개선
- **주요 커밋**: `security: API 보안 설정 강화`, `Fix reroll functionality to preserve daily mission limits`

## 2025-08-18 (DDD 순수성 완성 & 최종 아키텍처 최적화)

### 1. DDD Aggregate 순수성 규칙 완성 🏛️
- **Value Object 분리**: User → UserLevelInfo VO로 레벨 계산 로직 완전 분리
- **Nested Class 분리**: HashtagStatsDomainService에서 PopularityThreshold enum 독립 클래스화
- **도메인 순수성**: 모든 비즈니스 로직을 VO로 캡슐화, Aggregate는 데이터 관리만
- **Factory 패턴**: `UserLevelInfo.fromPoints()` 등 복합 VO 생성 로직
- **주요 커밋**: `feat: nested enum 및 클래스 분리`

### 2. 백엔드 성능 최적화 ⚡
- **포인트 계산 최적화**: 월별 포인트 집계 실제 비즈니스 로직으로 교체
- **데모 계정 정규화**: ID 범위 1-5로 표준화, 테스트 안정성 향상
- **코드 품질**: 컴파일 경고 제거, 불필요한 import 정리
- **메모리 최적화**: 사용하지 않는 객체 참조 제거, GC 부담 감소
- **주요 커밋**: `perf: 백엔드 성능 최적화 및 코드 정리`, `feat: 이번 달 획득 포인트 실제 비즈니스 로직 구현`

### 3. Exception-Free Controller 패턴 구현 🎯
- **중앙 집중식 예외 처리**: 모든 Controller에서 try-catch 블록 제거
- **GlobalExceptionHandler 강화**: 도메인 예외를 HTTP 응답으로 자동 변환
- **Response DTO 분리**: 모든 Response 클래스를 별도 파일로 분리
- **비즈니스 예외**: Controller는 HTTP만, 비즈니스 예외는 Service에서 던지기
- **주요 원칙**: `Controller → Service → Domain, 예외는 역방향으로 전파`

### 4. Value Object 컨텍스트 조직화 📦
```kotlin
domain/vo/
├── common/        # 공통 VO (UserId, Points, ImageUrl)
├── user/          # 사용자 컨텍스트 (UserLevelInfo, Email, Streak)  
├── mission/       # 미션 컨텍스트 (MissionCategory, Difficulty)
├── achievement/   # 업적 컨텍스트 (AchievementType)
├── stat/          # 통계 컨텍스트 (StatType, CategoryStat)
└── hashtag/       # 해시태그 컨텍스트 (PopularityThreshold)
```
- **도메인 주도 설계**: 기술적 분류가 아닌 비즈니스 컨텍스트별 패키지 구성
- **응집성 강화**: 관련된 VO들을 함께 배치하여 개발 및 유지보수 효율성 향상

---

## 📊 개발 현황 요약 (보고서용)

### 🏗️ 아키텍처 & 기술 스택
- **언어**: Kotlin 1.9.25 + Spring Boot 3.5.4
- **데이터베이스**: PostgreSQL 17.5 (Docker), H2 (테스트) 
- **아키텍처**: Hexagonal Architecture + DDD (Domain-Driven Design)
- **인증**: 커스텀 JWT 구현 (Access 24h + Refresh 7d)
- **실시간 통신**: WebSocket (알림 시스템)
- **성능**: 커서 기반 페이징, PostgreSQL GIN 인덱스
- **보안**: BCrypt 해싱, Spring Security 6

### 📈 개발 진척도 (2025.08.14 ~ 08.18)
- **총 커밋 수**: 80+ 커밋
- **개발 기간**: 5일간 집중 개발
- **주요 마일스톤**: 4개 (초기 설정 → 인증 → DDD → 실시간 기능)
- **코드 라인**: 10,000+ lines (도메인 모델, 서비스, 컨트롤러)

### 🚀 핵심 구현 기능

#### 1. 사용자 시스템 👤
- **50레벨 시스템**: 8단계 타이틀 (BEGINNER → MYTHIC)
- **RPG 스탯**: 6가지 능력치 (근력, 지능, 창의성, 사교성, 모험심, 규율)
- **업적 시스템**: 12가지 업적 타입, 5단계 희귀도
- **데모 계정**: 개발/테스트용 원클릭 로그인

#### 2. 미션 시스템 🎯  
- **일일 미션**: 하루 5개 제한, 동시 진행 가능
- **5개 카테고리**: 건강, 창의, 사교, 모험, 학습
- **자동 스케줄러**: 24시간 후 미션 자동 만료
- **성공률 추적**: 카테고리별, 난이도별 통계

#### 3. 소셜 시스템 📱
- **스토리 공유**: 미션 인증 + 일반 스토리
- **좋아요 시스템**: 중복 방지, 실시간 카운트
- **실시간 알림**: WebSocket 기반 즉시 알림
- **피드 시스템**: 무한 스크롤, 커서 페이징

#### 4. 해시태그 검색 🔍
- **실시간 검색**: 자동완성, 트렌딩 분석
- **성능 최적화**: PostgreSQL GIN 인덱스
- **카테고리 필터**: 5개 카테고리별 분류
- **통계 집계**: 사용 빈도, 인기도 계산

#### 5. 게임화 시스템 🏆
- **포인트 시스템**: 미션 완료시 획득, 월별 집계
- **리워드 교환**: 6개 카테고리 가상 상품
- **스탯 할당**: 자동 +1, 수동 +2 포인트 시스템
- **레벨업**: 포인트 기반 자동 계산

### ⚠️ 주요 이슈 & 해결
1. **보안 취약점**: 비밀번호 평문 저장 → BCrypt 해시 적용
2. **성능 문제**: N+1 쿼리 → 최적화 쿼리 및 인덱스 적용  
3. **아키텍처**: Layered → Hexagonal + DDD 전환
4. **Spring Security**: 5.x → 6.x 마이그레이션 완료